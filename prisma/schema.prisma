// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id            String     @id @default(auto()) @map("_id") @db.ObjectId
  email         String     @unique
  name          String
  passwordHash  String
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  
  createdTasks  Task[]     @relation("CreatedTasks")
  comments      Comment[]
  refreshTokens RefreshToken[]
  createdEvents Event[]
  notifications Notification[]
}

model RefreshToken {
  id            String     @id @default(auto()) @map("_id") @db.ObjectId
  hashedToken   String     @unique
  userId        String     @db.ObjectId
  user          User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt     DateTime
  revokedAt     DateTime?
  createdAt     DateTime   @default(now())

  @@index([userId])
  @@index([expiresAt])
}

model Task {
  id            String     @id @default(auto()) @map("_id") @db.ObjectId
  equipment     String     // e.g., "L36"
  area          String     // e.g., "Rack bar-01"
  title         String     // Task description
  description   String?    // Additional details
  status        String     @default("pending") // pending, in-progress, completed
  priority      String     @default("medium") // low, medium, high
  assignedTo    String[]   @db.ObjectId // Array of User IDs (max 2)
  createdBy     String     @db.ObjectId
  creator       User       @relation("CreatedTasks", fields: [createdBy], references: [id], onDelete: Cascade)
  dueDate       DateTime?
  completedAt   DateTime?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  comments      Comment[]

  @@index([createdBy])
  @@index([status])
  @@index([createdAt])
}

model Notification {
  id              String     @id @default(auto()) @map("_id") @db.ObjectId
  userId          String     @db.ObjectId
  user            User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  taskId          String     @db.ObjectId
  type            String     // "assigned" or "reminder"
  message         String
  isRead          Boolean    @default(false)
  nextReminderAt  DateTime?  // When the next reminder should be sent
  createdAt       DateTime   @default(now())
  expiresAt       DateTime   // Auto-delete after 6 hours

  @@index([userId])
  @@index([taskId])
  @@index([isRead])
  @@index([nextReminderAt])
  @@index([expiresAt(sort: Asc)], map: "notification_ttl")
}

model Comment {
  id            String     @id @default(auto()) @map("_id") @db.ObjectId
  content       String
  taskId        String     @db.ObjectId
  task          Task       @relation(fields: [taskId], references: [id], onDelete: Cascade)
  authorId      String     @db.ObjectId
  author        User       @relation(fields: [authorId], references: [id], onDelete: Cascade)
  parentId      String?    @db.ObjectId // For nested replies
  parent        Comment?   @relation("CommentReplies", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  replies       Comment[]  @relation("CommentReplies")
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  @@index([taskId])
  @@index([authorId])
  @@index([parentId])
}

model Event {
  id            String     @id @default(auto()) @map("_id") @db.ObjectId
  title         String     // e.g., "Audit", "Safety Meeting"
  description   String?
  eventDate     DateTime   // When the event will occur
  createdBy     String     @db.ObjectId
  creator       User       @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  @@index([eventDate])
  @@index([createdBy])
}
